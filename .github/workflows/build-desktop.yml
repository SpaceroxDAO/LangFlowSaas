name: Build Desktop App

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: false
        default: ''
  push:
    tags:
      - 'desktop-v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            bun_target: bun-darwin-arm64
          - platform: macos-latest
            target: x86_64-apple-darwin
            bun_target: bun-darwin-x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            bun_target: bun-windows-x64

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # macOS: install system dependencies
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          # Tauri v2 on macOS doesn't need extra deps beyond Xcode CLI tools

      # Build tc-connector sidecar binary
      - name: Build tc-connector TypeScript
        run: |
          cd tc-connector
          npm ci
          npm run build

      - name: Compile sidecar binary
        shell: bash
        run: |
          mkdir -p tc-agent/src-tauri/binaries
          SUFFIX=""
          if [[ "${{ matrix.target }}" == *"windows"* ]]; then
            SUFFIX=".exe"
          fi
          bun build tc-connector/dist/index.js \
            --compile \
            --target=${{ matrix.bun_target }} \
            --outfile tc-agent/src-tauri/binaries/tc-connector-${{ matrix.target }}${SUFFIX}

      # Install frontend dependencies
      - name: Install frontend dependencies
        run: |
          cd tc-agent
          npm ci

      # Build Tauri app (allow DMG bundler to fail — we create it manually)
      - name: Build Tauri app
        continue-on-error: true
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          VITE_TC_API_URL: https://app.teachcharlie.ai
          # Code signing (optional — set secrets when ready)
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: tc-agent
          tauriScript: npm run tauri
          args: --target ${{ matrix.target }}

      # Verify the .app bundle was created (the actual binary — DMG is optional)
      - name: Verify build output
        if: runner.os == 'macOS'
        shell: bash
        run: |
          APP_PATH="tc-agent/src-tauri/target/${{ matrix.target }}/release/bundle/macos/Teach Charlie.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: .app bundle not found at $APP_PATH"
            exit 1
          fi
          echo "Build verified: $(du -sh "$APP_PATH" | cut -f1) .app bundle"

      # Create DMG manually if Tauri's bundler failed (known macOS 15+ issue)
      - name: Create DMG (fallback)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          DMG_DIR="tc-agent/src-tauri/target/${{ matrix.target }}/release/bundle/dmg"
          DMG_PATH="$DMG_DIR/Teach Charlie_0.1.0_${{ matrix.target == 'aarch64-apple-darwin' && 'aarch64' || 'x86_64' }}.dmg"
          APP_PATH="tc-agent/src-tauri/target/${{ matrix.target }}/release/bundle/macos/Teach Charlie.app"

          if [ -f "$DMG_PATH" ]; then
            echo "DMG already exists, skipping manual creation"
          else
            echo "Creating DMG manually..."
            mkdir -p "$DMG_DIR"
            hdiutil create -volname "Teach Charlie" \
              -srcfolder "$APP_PATH" \
              -ov -format UDZO \
              "$DMG_PATH"
          fi
          echo "DMG created: $(du -sh "$DMG_PATH" | cut -f1)"

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: teach-charlie-${{ matrix.target }}
          path: |
            tc-agent/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            tc-agent/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.app
            tc-agent/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            tc-agent/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
          if-no-files-found: warn

  # Create GitHub Release when triggered by tag
  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/desktop-v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Teach Charlie Desktop ${{ github.ref_name }}
          draft: true
          prerelease: false
          files: artifacts/**/*
          body: |
            ## Teach Charlie Desktop

            Download the installer for your platform:
            - **macOS (Apple Silicon)**: `.dmg` (aarch64)
            - **macOS (Intel)**: `.dmg` (x86_64)
            - **Windows**: `.msi`

            ### First time?
            1. Download and install
            2. Open Teach Charlie
            3. Sign in with your account
            4. Your agent connects automatically
