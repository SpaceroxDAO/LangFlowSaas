# =============================================================================
# Teach Charlie AI - Security Scanning Workflow
# =============================================================================
# Runs on: Push to main, PRs, weekly schedule
# Purpose: Detect security vulnerabilities and code issues
#
# Scans included:
# - Dependency vulnerability scanning (pip-audit, npm audit)
# - Static Application Security Testing (Semgrep)
# - Secret detection (Gitleaks)
# - Container image scanning (Trivy)
# =============================================================================

name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Dependency Vulnerability Scanning
  # ===========================================================================
  dependency-scan:
    name: Dependency Vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Scan Python dependencies
        working-directory: src/backend
        run: |
          pip-audit -r requirements.txt --desc on --fix --dry-run || true
        continue-on-error: true

      - name: Scan Node.js dependencies
        working-directory: src/frontend
        run: |
          npm audit --audit-level=high || true
        continue-on-error: true

  # ===========================================================================
  # Static Application Security Testing (SAST)
  # ===========================================================================
  sast:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/python
            p/typescript
            p/react
          generateSarif: "1"
        continue-on-error: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always()
        continue-on-error: true

  # ===========================================================================
  # Secret Detection
  # ===========================================================================
  secrets-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ===========================================================================
  # Container Image Scanning
  # ===========================================================================
  container-scan:
    name: Container Scan (Trivy)
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Build backend image for scanning
        run: |
          docker build -t backend-scan:latest ./src/backend

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "backend-scan:latest"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
        if: always()
        continue-on-error: true

  # ===========================================================================
  # Summary
  # ===========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast, secrets-scan]
    if: always()

    steps:
      - name: Check scan results
        run: |
          echo "Security scanning completed."
          echo ""
          echo "Review the Security tab in GitHub for detailed findings."
          echo "Note: Scans are configured to continue on error to provide full visibility."
