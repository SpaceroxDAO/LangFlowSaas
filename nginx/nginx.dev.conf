# Teach Charlie AI - Local Development nginx Configuration
# Purpose: Proxy Langflow with CSS/JS injection for local dev
#
# This config is for LOCAL DEV ONLY where:
#   - Frontend runs on host machine (npm run dev)
#   - Backend runs on host machine (uvicorn)
#   - Only Langflow needs Docker proxying with CSS injection
#
# Usage:
#   docker-compose -f docker-compose.dev.yml up -d

# ===========================================
# WebSocket Upgrade Detection
# ===========================================
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# =========================================================================
# LANGFLOW SERVER (Port 7861)
# Serves Langflow at ROOT path with CSS/JS injection for white-labeling
# This is the ONLY server needed for local dev
# =========================================================================
server {
    listen 7861;
    server_name localhost;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Allow iframe embedding from our frontend (CRITICAL for iframe to work)
    add_header X-Frame-Options "ALLOWALL" always;
    add_header Content-Security-Policy "frame-ancestors *" always;

    # CORS headers for cross-port access (localhost:3001 -> localhost:7861)
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Upgrade, Connection" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    # =====================================================
    # Overlay files (CSS/JS for hiding Langflow UI elements)
    # =====================================================
    location /overlay/ {
        alias /usr/share/nginx/html/overlay/;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Access-Control-Allow-Origin "*";

        types {
            text/css css;
            application/javascript js;
        }
    }

    # =====================================================
    # Langflow Proxy with WebSocket + CSS/JS injection
    # =====================================================
    location / {
        # In local dev, langflow runs in Docker at langflow:7860
        proxy_pass http://langflow:7860;
        proxy_http_version 1.1;

        # WebSocket Support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Remove Langflow's restrictive headers for iframe embedding
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;

        # Disable buffering for WebSockets
        proxy_buffering off;

        # Extended timeouts (24 hours for WebSocket idle)
        proxy_connect_timeout 60s;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # CSS/JS Injection via sub_filter
        proxy_set_header Accept-Encoding "";

        sub_filter_types text/html;
        sub_filter_once on;
        sub_filter '</head>' '<link rel="stylesheet" href="/overlay/style.css?v=12"></head>';
        sub_filter '</body>' '<script src="/overlay/script.js?v=12"></script></body>';
    }

    # Health check
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
